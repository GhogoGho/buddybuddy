<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="memberMapper">

	<resultMap type="Member" id="member_rm">
		<id property="memberNo" column="MEMBER_NO" />


		<result property="memberEmail" column="MEMBER_EMAIL" />
		<result property="memberPw" column="MEMBER_PW" />
		<result property="memberNickname" column="MEMBER_NICKNAME" />
		<result property="memberGrade" column="MEMBER_GRADE" />
		<result property="memberRegdate" column="MEMBER_REGDATE" />
		<result property="memberProfile" column="MEMBER_PROFILE" />
		<result property="memberStatus" column="MEMBER_STATUS" />

	</resultMap>
	
	
	<!-- Pagination용 resultMap -->
	<resultMap type="OnPagination" id="pg_rm">
		<result property="listCount" column="CNT"/>
		<result property="className" column="CLASS_TYPE_NAME"/>
	</resultMap>
	
	<!-- online 조회용 -->	
	<resultMap type="Online" id="online_rm">
		<id property="classNo" column="CLASS_NO"/>
	
		<result property="classTitle" column="CLASS_TITLE"/>
		<result property="memberNickName" column="MEMBER_NICKNAME"/>
		<result property="categoryName" column="CATEGORY_NAME"/>
		<result property="categoryNo" column="CATEGORY_NO"/>
		<result property="classType" column="CLASS_TYPE_NO"/>
		<result property="classReadCount" column="CLASS_READ_COUNT"/>
		<result property="classCreateDate" column="CLASS_CREATE_DT"/>
		
		<result property="classContent" column="CLASS_CONTENT"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="onlineLike" column="ONLINE_LIKE"/>
		 
		<collection property="atList" column="CLASS_NO" 
			javaType="java.util.ArrayList" ofType="Attachment" select="selectAttachment"/>
	</resultMap>
	
	<!-- offline 조회용 -->
	<resultMap type="OfflineClass" id="offline_rm">
		<id property="classNo" column="CLASS_NO" />

		<result property="classTitle" column="CLASS_TITLE" />
		<result property="classContent" column="CLASS_CONTENT" />
		<result property="classCreateDate" column="CLASS_CREATE_DT" />
		<result property="classReadCount" column="CLASS_READ_COUNT" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="reviewRatings" column="REVIEW_RATINGS" />
		<result property="memberNickName" column="MEMBER_NICKNAME" />
		<result property="categoryName" column="CATEGORY_NAME" />
		<result property="memberProfile" column="MEMBER_PROFILE" />
		<result property="reserveDate" column="RESERVE_DATE" />
		<result property="reserveStart" column="RESERVE_START" />
		<result property="reserveEnd" column="RESERVE_END" />
		<result property="reserveLimit" column="RESERVE_LIMIT" />
		<result property="classLevel" column="CLASS_LEVEL" />
		<result property="classArea" column="CLASS_AREA" />
		<result property="paymentStatus" column="PAYMENT_STATUS" />
		<result property="classPrice" column="CLASS_PRICE" />
		<result property="reserveDate" column="RESERVE_DT" />
		<result property="count" column="XXX" />
		<result property="reserveNo" column="RESERVE_NO" />
		<collection property="atList" column="CLASS_NO"
			javaType="java.util.ArrayList" ofType="OffAttachment"
			select="selectAttachment" />
	</resultMap>
	
	

	<!-- 회원가입 -->
	<insert id="signUp" parameterType="Member">
		INSERT INTO MEMBER
		VALUES(
		SEQ_MNO.NEXTVAL, #{memberEmail}, #{memberPw}, #{memberNickname},
		'N', DEFAULT, DEFAULT, DEFAULT )
	</insert>

	<!-- id 중복검사 -->
	<select id="idDupCheck" parameterType="string" resultType="_int">
		SELECT COUNT(*) FROM MEMBER
		WHERE MEMBER_EMAIL = #{id}
	</select>

	<!-- 로그인 -->
	<select id="login" parameterType="string" resultMap="member_rm">
		SELECT *
		FROM MEMBER
		WHERE MEMBER_STATUS = 'Y'
		AND MEMBER_EMAIL = #{memberEmail}
	</select>

	<!-- 비밀번호 변경(조회) -->
	<select id="selectPassword" parameterType="_int"
		resultType="string">
		SELECT MEMBER_PW FROM MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<!-- 비밀번호 변경 -->
	<update id="changePwd" parameterType="Member">
		UPDATE MEMBER SET
		MEMBER_PW = #{memberPw}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- 회원정보 수정 -->
	<update id="updateInfo" parameterType="Member">
		UPDATE MEMBER SET
		MEMBER_EMAIL = #{memberEmail},
		MEMBER_NICKNAME = #{memberNickname}
		<if test="memberProfile != null">
			, MEMBER_PROFILE = #{memberProfile}
		</if>
		WHERE MEMBER_NO = #{memberNo}
	</update>


	<!-- 회원탈퇴 조회 -->
	<select id="selectMember" parameterType="_int"
		resultType="string">
		SELECT MEMBER_PW FROM MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<!-- 회원탈퇴 -->
	<update id="secession" parameterType="_int">
		UPDATE MEMBER SET
		MEMBER_STATUS = 'N'
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- 크리에이터 회원가입 -->
	<insert id="creatorSignUp" parameterType="Member">
		INSERT INTO MEMBER
		VALUES( SEQ_MNO.NEXTVAL, #{memberEmail}, #{memberPw},
		#{memberNickname},
		'T', DEFAULT, DEFAULT, DEFAULT )
	</insert>

	<!-- 아이디 찾기 -->
	<select id="findId" parameterType="Member" resultType="string">
		SELECT
		MEMBER_EMAIL FROM MEMBER
		WHERE MEMBER_EMAIL = #{memberEmail}
		AND
		MEMBER_STATUS = 'Y'
	</select>
 
	<!-- 비밀번호 변경 -->
	<update id="updatePw">
		UPDATE MEMBER SET MEMBER_PW = #{memberPw}
		WHERE MEMBER_EMAIL = #{memberEmail}
	</update>
	
	<!-- 비번 찾기 가입회원 조회 -->
	<select id="findMember" parameterType="Member" resultType="string">
		SELECT * FROM MEMBER
		WHERE MEMBER_EMAIL = #{memberEmail}
	</select>
	
	<!-- 카카오 로그인용 정보 조회 -->
	<select id="kakaoLogin" parameterType="Member" resultMap="member_rm">
		SELECT * FROM MEMBER
		WHERE MEMBER_EMAIL = #{memberEmail}
	</select>

	<!-- 온라인 클래스 조회 -->
	<select id="selectOnlineList" parameterType="_int" resultMap="online_rm">
		SELECT * FROM ONLINE_LIST
		WHERE CLASS_STATUS = 'Y'
		AND CLASS_TYPE_NO = #{classType}
		AND MEMBER_NO = #{memberNo}
		ORDER BY CLASS_NO DESC
	</select>
	
	<!-- 전체 이용내역 조회 -->
	<select id="getListCount" parameterType="_int" resultMap="pg_rm">
		SELECT
		CNT, (SELECT CLASS_TYPE_NAME FROM CLASS_TYPE WHERE CLASS_TYPE_NO = #{classType}) CLASS_TYPE_NAME
		FROM (SELECT COUNT(*) CNT
		FROM ONLINE_LIST
		WHERE CLASS_TYPE_NO = #{classType} AND CLASS_STATUS = 'Y')
	</select>
	
	<!-- 오프라인 클래스 전체 조회 -->
	<select id="selectOfflineList" parameterType="_int" resultMap="offline_rm">
		SELECT CLASS_NO,CATEGORY_NAME, CLASS_TITLE FROM
		CLASS_PAGE
		LEFT JOIN CATEGORY USING(CATEGORY_NO)
		WHERE CLASS_TYPE_NO =#{classType}
		AND CLASS_STATUS = 'Y'
		ORDER BY CLASS_NO DESC
	</select>

</mapper>
